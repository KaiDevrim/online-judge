services:
  db:
    image: mariadb:10.11
    container_name: dmoj_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-dmoj}
      MYSQL_USER: ${MYSQL_USER:-dmoj}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql_:/var/lib/mysql
    networks:
      - dmoj_net
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_general_ci
      --default-authentication-plugin=mysql_native_password

  redis:
    image: redis:7-alpine
    container_name: dmoj_redis
    restart: unless-stopped
    volumes:
      - redis_:/data
    networks:
      - dmoj_net
    command: redis-server --appendonly yes

  site:
    build:
      context: .
      dockerfile: Dockerfile
    image: dmoj/site:latest
    container_name: dmoj_site
    restart: unless-stopped
    depends_on:
      - db
      - redis
    environment:
      DJANGO_SETTINGS_MODULE: dmoj.settings
      MYSQL_HOST: db
      MYSQL_PORT: 3306
      MYSQL_DATABASE: ${MYSQL_DATABASE:-dmoj}
      MYSQL_USER: ${MYSQL_USER:-dmoj}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
    volumes:
      - ./local_settings.py:/site/dmoj/local_settings.py:ro
      - site_static:/site/static_root
      - site_media:/site/media
      - pdfcache:/site/pdfcache
      - datacache:/site/datacache
      - problems:/problems
    networks:
      - dmoj_net
    entrypoint: >
      sh -c "
        python3 manage.py migrate &&
        python3 manage.py loaddata navbar &&
        python3 manage.py loaddata language_small &&
        python3 manage.py loaddata demo &&
        python3 manage.py compilemessages &&
        python3 manage.py compilejsi18n &&
        ./make_style.sh &&
        python3 manage.py collectstatic --noinput &&
        gunicorn dmoj.wsgi:application --bind 0.0.0.0:8000 --workers 2 --threads 4 --worker-class gthread --timeout 60 --access-logfile - --error-logfile -
      "

  celery:
    image: dmoj/site:latest
    container_name: dmoj_celery
    restart: unless-stopped
    depends_on:
      - db
      - redis
      - site
    environment:
      DJANGO_SETTINGS_MODULE: dmoj.settings
      MYSQL_HOST: db
      MYSQL_DATABASE: ${MYSQL_DATABASE:-dmoj}
      MYSQL_USER: ${MYSQL_USER:-dmoj}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      REDIS_HOST: redis
    volumes:
      - ./local_settings.py:/site/dmoj/local_settings.py:ro
      - site_media:/site/media
      - problems:/problems
    networks:
      - dmoj_net
    command: celery -A dmoj_celery worker -l info

  bridged:
    image: dmoj/site:latest
    container_name: dmoj_bridged
    restart: unless-stopped
    depends_on:
      - db
      - redis
      - site
    environment:
      MYSQL_HOST: db
      MYSQL_DATABASE: ${MYSQL_DATABASE:-dmoj}
      MYSQL_USER: ${MYSQL_USER:-dmoj}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      REDIS_HOST: redis
    volumes:
      - ./local_settings.py:/site/dmoj/local_settings.py:ro
      - problems:/problems
    networks:
      - dmoj_net
    ports:
      - "9999:9999"
    command: python3 manage.py runbridged

  wsevent:
    image: node:18-alpine
    container_name: dmoj_wsevent
    restart: unless-stopped
    working_dir: /app/websocket
    depends_on:
      - site
    volumes:
      - ./websocket:/app/websocket
    networks:
      - dmoj_net
    ports:
      - "15100:15100"
      - "15101:15101"
      - "15102:15102"
    entrypoint: >
      sh -c "
        npm install qu ws simplesets &&
        node daemon.js
      "

  nginx:
    image: nginx:alpine
    container_name: dmoj_nginx
    restart: unless-stopped
    depends_on:
      - site
      - wsevent
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - site_static:/site/resources:ro
      - site_media:/site/media:ro
      - pdfcache:/site/pdfcache:ro
      - datacache:/site/datacache:ro
    networks:
      - dmoj_net

volumes:
  mysql_:
    driver: local
  redis_:
    driver: local
  site_static:
    driver: local
  site_media:
    driver: local
  pdfcache:
    driver: local
  datacache:
    driver: local
  problems:
    driver: local


networks:
  dmoj_net:
    driver: bridge
